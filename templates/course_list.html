{% extends 'base.html' %}
{% block title %}Courses{% endblock %}
{% load custom_filters %}
{% block content %}
<head>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
</head>

<style>
    .glass-button {
        background: white;
        color: #8e2de2;
        border: 2px solid #8e2de2;
        border-radius: 12px;
        padding: 10px 20px;
        font-weight: 500;
        text-decoration: none;
        display: inline-block;
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
        box-shadow: inset 0 0 8px rgba(255, 255, 255, 0.08), 0 4px 12px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
    }

    .glass-button:hover {
        background: #8e2de2;
        color: white;
        border-color: #8e2de2;
        box-shadow: inset 0 0 10px rgba(255, 255, 255, 0.1), 0 6px 16px rgba(0, 0, 0, 0.3);
    }

    table.table {
        border-radius: 10px;
        overflow: hidden;
        background-color: #fff;
    }

    thead.table-dark th {
        color: #fff;
        border: none;
    }

    table td, table th {
        vertical-align: middle;
        text-align: center;
    }

    .btn-sm {
        padding: 4px 10px;
        font-size: 0.85rem;
    }

    h2 {
        font-weight: 600;
        color: #000000;
        text-align: center;
    }
    input.form-control {
        text-align: left !important;
    }
</style>

<div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="mb-0">MANAGE COURSES</h2>
    <a href="{% url 'add_course' %}" class="glass-button mt-2">➕ Add Course</a>
</div>

<form method="get" class="mb-3 d-flex align-items-center gap-2">
    <label for="deptFilter" class="fw-bold">Filter by Department:</label>
    <select id="deptFilter" name="department" class="form-select w-auto" onchange="this.form.submit()">
        <option value="">All</option>
        {% for dept in departments %}
            <option value="{{ dept.dept_name }}" {% if selected_dept == dept.dept_name %}selected{% endif %}>
                {{ dept.dept_name }}
            </option>
        {% endfor %}
    </select>
</form>

<table class="table table-bordered table-striped shadow-sm">
    <thead class="table-dark">
        <tr>
            <th>SI.No</th>
            <th>Name</th>
            <th>Code</th>
            <th>Credits</th>
            <th>Department</th>
            <th>Programme</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        {% for course in courses %}
        <tr class="course-row" data-course-id="{{ course.course_id }}" style="cursor: pointer;">
            <td>{{ forloop.counter }}</td>
            <td>{{ course.name }}</td>
            <td>{{ course.code }}</td>
            <td>{{ course.credit }}</td>
            <td>{{ course.dept.dept_name }}</td>
            <td>{{ course.pgm.pgm_name }}</td>
            <td>
                <a href="{% url 'edit_course' course.course_id %}" title="Edit" class="text-warning me-2" style="font-size: 1.2rem;">
                    <i class="bi bi-pencil-square"></i>
                </a>
                <form action="{% url 'delete_course' course.course_id %}" method="post" style="display:inline;">
                    {% csrf_token %}
                    <button type="submit" title="Delete" class="text-danger border-0 bg-transparent p-0" style="font-size: 1.2rem;">
                        <i class="bi bi-trash"></i>
                    </button>
                </form>
            </td>
        </tr>

        <tr class="batch-row" id="batch-{{ course.course_id }}" style="display: none;">
            <td colspan="7">

                <div class="d-flex justify-content-start mt-3">
                <button class="btn btn-sm text-white" style="background-color: #8e2de2;" data-bs-toggle="modal" data-bs-target="#addBatchModal-{{ course.course_id }}">
                    ➕ Add Batch
                </button>
            </div>

                <div class="table-responsive w-75 mt-3">
    <table class="table table-sm table-bordered">
        <thead class="table-secondary">
            <tr>
                <th>SI.No</th>
                <th>Academic Year</th>
                <th>Part</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for batch in course.batch_set.all %}
            <tr>
                <td>{{ forloop.counter }}</td>
                <td>{{ batch.acad_year }}</td>
                <td>{{ batch.part }}</td>

                <!-- STATUS column: posts to toggle view -->
                <td>
                    <form method="post" action="{% url 'toggle_batch_activation' batch.batch_id %}" style="display:inline;" onsubmit="event.stopPropagation();">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-sm {% if batch.is_active %}btn-success{% else %}btn-outline-secondary{% endif %}">
                            {% if batch.is_active %}Active{% else %}Inactive{% endif %}
                        </button>
                    </form>
                </td>

                <!-- ACTIONS column -->
                <td>
                    <!-- Edit button (opens modal) -->
                    <button class="btn btn-sm btn-warning me-2" data-bs-toggle="modal" data-bs-target="#editBatchModal-{{ batch.batch_id }}" onclick="event.stopPropagation()">
                        <i class="bi bi-pencil-square"></i>
                    </button>

                    <!-- Delete form -->
                    <form action="{% url 'delete_batch' batch.batch_id %}" method="post" style="display:inline;" onsubmit="event.stopPropagation(); return confirm('Delete this batch?');">
                        {% csrf_token %}
                        <button type="submit" title="Delete" class="btn btn-sm btn-danger">
                            <i class="bi bi-trash"></i>
                        </button>
                    </form>
                </td>
            </tr>

            <!-- Keep your modal for edit here (OK to keep as-is) -->
            <div class="modal fade" id="editBatchModal-{{ batch.batch_id }}" tabindex="-1" aria-labelledby="editBatchLabel-{{ batch.batch_id }}" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content shadow">
                        <div class="modal-header bg-dark text-white">
                            <h5 class="modal-title">Edit Batch - {{ course.name }}</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <form method="post" action="{% url 'edit_batch' batch.batch_id %}">
                            {% csrf_token %}
                            <div class="modal-body">
                                {% with form=edit_forms|dict_get:batch.batch_id %}
                                {{ form.as_p }}
                            {% endwith %}
                            </div>
                            <div class="modal-footer">
                                <button type="submit" class="btn btn-success">Update</button>
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            {% empty %}
            <tr><td colspan="5" class="text-center">No batches found.</td></tr>
            {% endfor %}
        </tbody>
    </table>
</div>


                <div class="modal fade" id="addBatchModal-{{ course.course_id }}" tabindex="-1" aria-labelledby="addBatchLabel-{{ course.course_id }}" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content shadow">
                            <div class="modal-header bg-dark text-white">
                                <h5 class="modal-title" id="addBatchLabel-{{ course.course_id }}">Add Batch - {{ course.name }}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <form method="post" action="{% url 'add_batch' course.course_id %}">
                                {% csrf_token %}
                                <div class="modal-body">
                                    {{ batch_form.as_p }}
                                </div>
                                <div class="modal-footer">
                                    <button type="submit" class="btn btn-success">Save</button>
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<script>
    // Toggle batch row display when clicking a course-row
    document.querySelectorAll('.course-row').forEach(row => {
        row.addEventListener('click', () => {
            const courseId = row.dataset.courseId;
            const batchRow = document.getElementById('batch-' + courseId);
            batchRow.style.display = batchRow.style.display === 'none' ? 'table-row' : 'none';
        });
    });

    // Prevent button/form clicks in the row from toggling the batch row
    // (this is defensive — we also added inline stopPropagation on the buttons/forms)
    document.querySelectorAll('.course-row button, .course-row form').forEach(el => {
        el.addEventListener('click', function(e) {
            e.stopPropagation();
        });
    });
</script>
{% endblock %}