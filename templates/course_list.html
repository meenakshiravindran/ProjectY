{% extends 'base.html' %}
{% block title %}Courses{% endblock %}
{% block content %}
<h2 class="mb-3">Courses</h2>
<a href="{% url 'add_course' %}" class="btn btn-primary mb-3">Add Course</a>

<table class="table table-bordered table-striped">
    <thead class="table-dark">
        <tr>
            <th>SI.No</th>
            <th>Name</th>
            <th>Code</th>
            <th>Credits</th>
            <th>Department</th>
            <th>Programme</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        {% for course in courses %}
    <tr class="course-row" data-course-id="{{ course.course_id }}" style="cursor: pointer;">
        <td>{{ forloop.counter }}</td>
        <td>{{ course.name }}</td>
        <td>{{ course.code }}</td>
        <td>{{ course.credit }}</td>
        <td>{{ course.dept.dept_name }}</td>
        <td>{{ course.pgm.pgm_name }}</td>
        <td>
            <a href="{% url 'edit_course' course.course_id %}" class="btn btn-sm btn-warning">Edit</a>
            <form action="{% url 'delete_course' course.course_id %}" method="post" style="display:inline;">
                {% csrf_token %}
                <button type="submit" class="btn btn-sm btn-danger">Delete</button>
            </form>
        </td>
    </tr>

    <tr class="batch-row" id="batch-{{ course.course_id }}" style="display: none;">
        <td colspan="7">
            <strong>Batches:</strong>
    
            <!-- Add Batch Button triggers modal -->
            <div class="mt-2">
                <button class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#addBatchModal-{{ course.course_id }}">
                    Add Batch
                </button>
            </div>
    
            <!-- Batches Table -->
            <div class="table-responsive w-75 mt-3">
                <table class="table table-sm table-bordered">
                    <thead class="table-secondary">
                        <tr>
                            <th>Academic Year</th>
                            <th>Part</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for batch in course.batch_set.all %}
                        <tr>
                            <td>{{ batch.acad_year }}</td>
                            <td>{{ batch.part }}</td>
                        </tr>
                        {% empty %}
                        <tr><td colspan="2" class="text-center">No batches found.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
    
            <!-- Modal Structure (inserted per course) -->
            <div class="modal fade" id="addBatchModal-{{ course.course_id }}" tabindex="-1" aria-labelledby="addBatchLabel-{{ course.course_id }}" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content shadow">
                        <div class="modal-header bg-dark text-white">
                            <h5 class="modal-title" id="addBatchLabel-{{ course.course_id }}">Add Batch - {{ course.name }}</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <form method="post" action="{% url 'add_batch' course.course_id %}">
                            {% csrf_token %}
                            <div class="modal-body">
                                {{ batch_form.as_p }}  {# This must be passed from the view #}
                            </div>
                            <div class="modal-footer">
                                <button type="submit" class="btn btn-success">Save</button>
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
    
        </td>
    </tr>
    
    {% endfor %}

    </tbody>
</table>
<script>
    document.querySelectorAll('.course-row').forEach(row => {
        row.addEventListener('click', () => {
            const courseId = row.dataset.courseId;
            const batchRow = document.getElementById('batch-' + courseId);
            batchRow.style.display = batchRow.style.display === 'none' ? 'table-row' : 'none';
        });
    });
    </script>
{% endblock %}
